(function(a){if(typeof define==="function"&&define.amd){define(["jquery","ChineseDistricts"],a);}else{if(typeof exports==="object"){a(require("jquery"),require("ChineseDistricts"));}else{a(jQuery,ko.getChineseDistricts(null));}}})(function(h,e){if(typeof e==="undefined"){throw new Error('The file "city-picker.data.js" must be included first!');}var a="citypicker";var d="change."+a;var g="province";var b="city";var c="district";function f(j,i){this.$element=h(j);this.$dropdown=null;this.options=h.extend({},f.DEFAULTS,h.isPlainObject(i)&&i);this.active=false;this.dems=[];this.needBlur=false;this.init();}f.prototype={constructor:f,init:function(){this.defineDems();this.render();this.bind();this.active=true;},render:function(){var m=this.getPosition(),n=this.$element.attr("placeholder")||this.options.placeholder,i='<span class="city-picker-span" style="'+this.getWidthStyle(m.width)+"height:"+m.height+"px;line-height:"+(m.height-1)+'px;">'+(n?'<span class="placeholder">'+n+"</span>":"")+'<span class="title"></span><div class="arrow"></div></span>',l=this.options.left||0,k=this.options.top||0,o='<div class="city-picker-dropdown" style="'+this.getWidthStyle(m.width,true)+'"><div class="city-select-wrap"><div class="city-select-tab"><a class="active" data-count="province">省份</a>'+(this.includeDem("city")?'<a data-count="city">城市</a>':"")+(this.includeDem("district")?'<a data-count="district">区县</a>':"")+'</div><div class="city-select-content"><div class="city-select province" data-count="province"></div>'+(this.includeDem("city")?'<div class="city-select city" data-count="city"></div>':"")+(this.includeDem("district")?'<div class="city-select district" data-count="district"></div>':"")+"</div></div>";this.$element.addClass("city-picker-input");this.$textspan=h(i).insertAfter(this.$element);this.$dropdown=h(o).insertAfter(this.$textspan);var j=this.$dropdown.find(".city-select");h.each(this.dems,h.proxy(function(p,q){this["$"+q]=j.filter("."+q+"");},this));this.refresh();},refresh:function(j){var i=this.$dropdown.find(".city-select");i.data("item",null);var k=this.$element.val()||"";k=k.split("/");h.each(this.dems,h.proxy(function(l,m){if(k[l]&&l<k.length){this.options[m]=k[l];}else{if(j){this.options[m]="";}}this.output(m);},this));this.tab(g);this.feedText();this.feedVal();},defineDems:function(){var i=false;h.each([g,b,c],h.proxy(function(j,k){if(!i){this.dems.push(k);}if(k===this.options.level){i=true;}},this));},includeDem:function(i){return h.inArray(i,this.dems)!==-1;},getPosition:function(){var m,l,i,k,j;m=this.$element.position();k=this.getSize(this.$element);l=k.height;i=k.width;if(this.options.responsive){j=this.$element.offsetParent().width();if(j){i=i/j;if(i>0.99){i=1;}i=i*100+"%";}}return{top:m.top||0,left:m.left||0,height:l,width:i};},getSize:function(i){var j,l,k;if(!i.is(":visible")){j=h("<div />").appendTo(h("body"));j.css({position:"absolute !important",visibility:"hidden !important",display:"block !important"});l=i.clone().appendTo(j);k={width:l.outerWidth(),height:l.outerHeight()};j.remove();}else{k={width:i.outerWidth(),height:i.outerHeight()};}return k;},getWidthStyle:function(i,j){if(this.options.responsive&&!h.isNumeric(i)){return"width:"+i+";";}else{return"width:"+(j?Math.max(320,i):i)+"px;";}},bind:function(){var i=this;h(document).on("click",(this._mouteclick=function(m){var j=h(m.target);var l,k,n;if(j.is(".city-picker-span")){k=j;}else{if(j.is(".city-picker-span *")){k=j.parents(".city-picker-span");}}if(j.is(".city-picker-input")){n=j;}if(j.is(".city-picker-dropdown")){l=j;}else{if(j.is(".city-picker-dropdown *")){l=j.parents(".city-picker-dropdown");}}if((!n&&!k&&!l)||(k&&k.get(0)!==i.$textspan.get(0))||(n&&n.get(0)!==i.$element.get(0))||(l&&l.get(0)!==i.$dropdown.get(0))){i.close(true);}}));this.$element.on("change",(this._changeElement=h.proxy(function(){this.close(true);this.refresh(true);},this))).on("focus",(this._focusElement=h.proxy(function(){this.needBlur=true;this.open();},this))).on("blur",(this._blurElement=h.proxy(function(){if(this.needBlur){this.needBlur=false;this.close(true);}},this)));this.$textspan.on("click",function(l){var j=h(l.target),k;i.needBlur=false;if(j.is(".select-item")){k=j.data("count");i.open(k);}else{if(i.$dropdown.is(":visible")){i.close();}else{i.open();}}}).on("mousedown",function(){i.needBlur=false;});this.$dropdown.on("click",".city-select a",function(){var k=h(this).parents(".city-select");var j=k.find("a.active");var l=k.next().length===0;j.removeClass("active");h(this).addClass("active");if(j.data("code")!==h(this).data("code")){k.data("item",{address:h(this).attr("title"),code:h(this).data("code")});h(this).trigger(d);i.feedText();i.feedVal();if(l){i.close();}}}).on("click",".city-select-tab a",function(){if(!h(this).hasClass("active")){var j=h(this).data("count");i.tab(j);}}).on("mousedown",function(){i.needBlur=false;});if(this.$province){this.$province.on(d,(this._changeProvince=h.proxy(function(){this.output(b);this.output(c);this.tab(b);},this)));}if(this.$city){this.$city.on(d,(this._changeCity=h.proxy(function(){this.output(c);this.tab(c);},this)));}},open:function(i){i=i||g;this.$dropdown.show();this.$textspan.addClass("open").addClass("focus");this.tab(i);},close:function(i){this.$dropdown.hide();this.$textspan.removeClass("open");if(i){this.$textspan.removeClass("focus");}},unbind:function(){h(document).off("click",this._mouteclick);this.$element.off("change",this._changeElement);this.$element.off("focus",this._focusElement);this.$element.off("blur",this._blurElement);this.$textspan.off("click");this.$textspan.off("mousedown");this.$dropdown.off("click");this.$dropdown.off("mousedown");if(this.$province){this.$province.off(d,this._changeProvince);}if(this.$city){this.$city.off(d,this._changeCity);}},getText:function(){var i="";this.$dropdown.find(".city-select").each(function(){var k=h(this).data("item"),j=h(this).data("count");if(k){i+=(h(this).hasClass("province")?"":"/")+'<span class="select-item" data-count="'+j+'" data-code="'+k.code+'">'+k.address+"</span>";}});return i;},getPlaceHolder:function(){return this.$element.attr("placeholder")||this.options.placeholder;},feedText:function(){var i=this.getText();if(i){this.$textspan.find(">.placeholder").hide();this.$textspan.find(">.title").html(this.getText()).show();}else{this.$textspan.find(">.placeholder").text(this.getPlaceHolder()).show();this.$textspan.find(">.title").html("").hide();}},getVal:function(){var i="";this.$dropdown.find(".city-select").each(function(){var j=h(this).data("item");if(j){i+=(h(this).hasClass("province")?"":"/")+j.address;}});return i;},feedVal:function(){this.$element.val(this.getVal());},output:function(o){var r=this.options;var l=this["$"+o];var m=o===g?{}:[];var q;var k;var i;var j=null;var p;if(!l||!l.length){return;}q=l.data("item");p=(q?q.address:null)||r[o];i=(o===g?86:o===b?this.$province&&this.$province.find(".active").data("code"):o===c?this.$city&&this.$city.find(".active").data("code"):i);k=h.isNumeric(i)?e[i]:null;var n=ko.toJSON(e[i]);if(h.isPlainObject(k)){h.each(k,function(v,s){var u;if(o===g){u=[];for(var t=0;t<s.length;t++){if(s[t].address===p){j={code:s[t].code,address:s[t].address};}u.push({code:s[t].code,address:s[t].address,selected:s[t].address===p});}m[v]=u;}else{if(s===p){j={code:v,address:s};}m.push({code:v,address:s,selected:s===p});}});}l.html(o===g?this.getProvinceList(m):this.getList(m,o));l.data("item",j);},getProvinceList:function(j){var i=[],k=this,l=this.options.simple;h.each(j,function(m,o){i.push('<dl class="clearfix">');i.push("<dt>"+m+"</dt><dd>");h.each(o,function(p,n){i.push('<a title="'+(n.address||"")+'" data-code="'+(n.code||"")+'" class="'+(n.selected?" active":"")+'">'+(l?k.simplize(n.address,g):n.address)+"</a>");});i.push("</dd></dl>");});return i.join("");},getList:function(k,i){var j=[],l=this,m=this.options.simple;j.push('<dl class="clearfix"><dd>');h.each(k,function(o,p){j.push('<a title="'+(p.address||"")+'" data-code="'+(p.code||"")+'" class="'+(p.selected?" active":"")+'">'+(m?l.simplize(p.address,i):p.address)+"</a>");});j.push("</dd></dl>");return j.join("");},simplize:function(i,j){i=i||"";if(j===g){return i.replace(/[省,市,自治区,壮族,回族,维吾尔]/g,"");}else{if(j===b){return i.replace(/[市,地区,回族,蒙古,苗族,白族,傣族,景颇族,藏族,彝族,壮族,傈僳族,布依族,侗族]/g,"").replace("哈萨克","").replace("自治州","").replace(/自治县/,"");}else{if(j===c){return i.length>2?i.replace(/[市,区,县,旗]/g,""):i;}}}},tab:function(l){var k=this.$dropdown.find(".city-select");var i=this.$dropdown.find(".city-select-tab > a");var j=this["$"+l];var m=this.$dropdown.find('.city-select-tab > a[data-count="'+l+'"]');if(j){k.hide();j.show();i.removeClass("active");m.addClass("active");}},reset:function(){this.$element.val(null).trigger("change");},setText:function(i){this.$element.val(i).trigger("change");},getValue:function(i){if(!i||!h.isArray(i)){i=[];}this.$dropdown.find(".city-select").each(function(){var j=h(this).data("item");if(j){i.push(j);}});},destroy:function(){this.unbind();this.$element.removeData(a).removeClass("city-picker-input");this.$textspan.remove();this.$dropdown.remove();}};f.DEFAULTS={simple:false,responsive:false,placeholder:"请选择省/市/区",level:"district",province:"",city:"",district:""};f.setDefaults=function(i){h.extend(f.DEFAULTS,i);};f.other=h.fn.citypicker;h.fn.citypicker=function(j){var i=[].slice.call(arguments,1);return this.each(function(){var n=h(this);var m=n.data(a);var k;var l;if(!m){if(/destroy/.test(j)){return;}k=h.extend({},n.data(),h.isPlainObject(j)&&j);n.data(a,(m=new f(this,k)));}if(typeof j==="string"&&h.isFunction(l=m[j])){l.apply(m,i);}});};h.fn.citypicker.Constructor=f;h.fn.citypicker.setDefaults=f.setDefaults;h.fn.citypicker.noConflict=function(){h.fn.citypicker=f.other;return this;};h(function(){});});
